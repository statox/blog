<!doctype html><html lang="en"><title>Highlighting yanked text with pure vimscript - The stuff I do</title><meta name="description" content="A personal blog where I write about my side projects"/><meta name="robots" content="index,follow"/><meta name="author" content="statox"/><link rel="canonical" href="https://www.statox.fr/posts/2020/07/vim_flash_yanked_text/"/><meta property="og:title" content="Highlighting yanked text with pure vimscript - The stuff I do"/><meta property="og:type" content="article"/><meta property="og:url" content="https://www.statox.fr/posts/2020/07/vim_flash_yanked_text/"/><meta property="og:description" content="A personal blog where I write about my side projects"/><meta name="twitter:card" content="summary"/><meta name="twitter:url" content="https://www.statox.fr/posts/2020/07/vim_flash_yanked_text/"/><meta name="twitter:title" content="Highlighting yanked text with pure vimscript - The stuff I do"/><meta name="twitter:description" content="A personal blog where I write about my side projects"/><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Highlighting yanked text with pure vimscript</title><meta name="description" content="A personal blog where I write about my side projects"/><meta name="keywords" content="statox blog"/><meta property="og:title" content="The stuff I do"/><meta property="og:url" content="https://www.statox.fr"/><meta property="og:description" content="A personal blog where I write about my side projects"/><meta property="og:type" content="website"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5"/><script>const bigScreenQuery=window.matchMedia("(max-width: 600px)");let bigScreen=!bigScreenQuery.matches;function navbarNavigate(e){var t=document.getElementById("header-navbar");(bigScreen||t.className.includes("responsive"))&&(document.location.pathname=e)}function navbarToggle(){var e=document.getElementById("header-navbar");"topnav"===e.className?e.className+=" responsive":e.className="topnav"}function toggleDarkTheme(){var e="1"===getComputedStyle(document.documentElement).getPropertyValue("--is-light-theme");console.log("toggle to",e?"dark":"light","mode");var t,n;const o=e?"-d":"-l";for({current:t,target:n}of["--nc-tx-1","--nc-tx-2","--nc-tx-3","--nc-bg-0","--nc-bg-1","--nc-bg-2","--nc-bg-3","--nc-lk-1","--nc-lk-2","--nc-lk-tx","--nc-ac-1","--nc-ac-tx"].map(e=>({current:e,target:e.slice(0,4)+o+e.slice(4)}))){var a=getComputedStyle(document.documentElement).getPropertyValue(n);document.documentElement.style.setProperty(t,a)}document.documentElement.style.setProperty("--is-light-theme",e?"0":"1"),writeLightThemeCookie(e?"0":"1")}function domReady(e){document.addEventListener("DOMContentLoaded",e),"interactive"!==document.readyState&&"complete"!==document.readyState||e()}function readLightThemeCookie(){return localStorage.getItem("lighttheme")}function writeLightThemeCookie(e){if("0"!==e&&"1"!==e)throw new Error("Invalid value for cookie lighttheme",e);localStorage.setItem("lighttheme",e)}bigScreenQuery.addListener(e=>bigScreen=!e.matches),domReady(()=>{var e,t=readLightThemeCookie();t&&(e=getComputedStyle(document.documentElement).getPropertyValue("--is-light-theme"),console.log({storedCookie:t,isLightProperty:e}),e!==t&&toggleDarkTheme())})</script><style>/*!
 * new.css framework forked from https://github.com/xz/new.css
 */:root{--nc-font-sans:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--nc-font-mono:Consolas,monaco,"Ubuntu Mono","Liberation Mono","Courier New",Courier,monospace;--is-light-theme:1;--nc-l-tx-1:#000000;--nc-l-tx-2:#1a1a1a;--nc-l-tx-3:#6d7169;--nc-l-bg-0:#cecece;--nc-l-bg-1:#ffffff;--nc-l-bg-2:#f6f8fa;--nc-l-bg-3:#e5e7eb;--nc-l-lk-1:#0070f3;--nc-l-lk-2:#0366d6;--nc-l-lk-tx:#ffffff;--nc-l-ac-1:#79ffe1;--nc-l-ac-tx:#0c4047;--nc-d-tx-1:#ffffff;--nc-d-tx-2:#eeeeee;--nc-d-tx-3:#8a8d87;--nc-d-bg-0:#13191c;--nc-d-bg-1:#000000;--nc-d-bg-2:#111111;--nc-d-bg-3:#222222;--nc-d-lk-1:#3291ff;--nc-d-lk-2:#0070f3;--nc-d-lk-tx:#ffffff;--nc-d-ac-1:#7928ca;--nc-d-ac-tx:#ffffff;--nc-tx-1:var(--nc-l-tx-1);--nc-tx-2:var(--nc-l-tx-2);--nc-tx-3:var(--nc-l-tx-3);--nc-bg-0:var(--nc-l-bg-0);--nc-bg-1:var(--nc-l-bg-1);--nc-bg-2:var(--nc-l-bg-2);--nc-bg-3:var(--nc-l-bg-3);--nc-lk-1:var(--nc-l-lk-1);--nc-lk-2:var(--nc-l-lk-2);--nc-lk-tx:var(--nc-l-lk-tx);--nc-ac-1:var(--nc-l-ac-1);--nc-ac-tx:var(--nc-l-ac-tx)}@media (prefers-color-scheme:dark){:root{--is-light-theme:0;--nc-tx-1:var(--nc-d-tx-1);--nc-tx-2:var(--nc-d-tx-2);--nc-bg-0:var(--nc-d-bg-0);--nc-bg-1:var(--nc-d-bg-1);--nc-bg-2:var(--nc-d-bg-2);--nc-bg-3:var(--nc-d-bg-3);--nc-lk-1:var(--nc-d-lk-1);--nc-lk-2:var(--nc-d-lk-2);--nc-lk-tx:var(--nc-d-lk-tx);--nc-ac-1:var(--nc-d-ac-1);--nc-ac-tx:var(--nc-d-ac-tx)}}*{margin:0;padding:0}address,area,article,aside,audio,blockquote,datalist,details,dl,fieldset,figure,form,iframe,img,input,meter,nav,ol,optgroup,option,output,p,pre,progress,ruby,section,table,textarea,ul,video{margin-bottom:1rem}button,html,input,select{font-family:var(--nc-font-sans)}body{margin:0 auto;max-width:750px;padding:2rem;border-radius:6px;overflow-x:hidden;word-break:break-word;overflow-wrap:break-word;background:var(--nc-bg-1);color:var(--nc-tx-2);font-size:1.03rem;line-height:1.5}::selection{background:var(--nc-ac-1);color:var(--nc-ac-tx)}h1,h2,h3,h4,h5,h6{line-height:1;color:var(--nc-tx-1);padding-top:.875rem}h1,h2,h3{color:var(--nc-tx-1);padding-bottom:2px;margin-bottom:8px;border-bottom:1px solid var(--nc-bg-2)}h4,h5,h6{margin-bottom:.3rem}h1{font-size:2.25rem}h2{font-size:1.85rem}h3{font-size:1.55rem}h4{font-size:1.25rem}h5{font-size:1rem}h6{font-size:.875rem}a{color:var(--nc-lk-1)}a:hover{color:var(--nc-lk-2)}abbr:hover{cursor:help}blockquote{padding:1.5rem;background:var(--nc-bg-2);border-left:5px solid var(--nc-bg-3)}abbr{cursor:help}blockquote :last-child{padding-bottom:0;margin-bottom:0}header{background:var(--nc-bg-2);border-bottom:1px solid var(--nc-bg-3);padding:2rem 1.5rem;margin:-2rem calc(0px - (50vw - 50%)) 2rem;padding-left:calc(50vw - 50%);padding-right:calc(50vw - 50%)}header h1,header h2,header h3{padding-bottom:0;border-bottom:0}header>:first-child{margin-top:0;padding-top:0}header>:last-child{margin-bottom:0}a button,button,input[type=button],input[type=reset],input[type=submit]{font-size:1rem;display:inline-block;padding:6px 12px;text-align:center;text-decoration:none;white-space:nowrap;background:var(--nc-lk-1);color:var(--nc-lk-tx);border:0;border-radius:4px;box-sizing:border-box;cursor:pointer;color:var(--nc-lk-tx)}a button[disabled],button[disabled],input[type=button][disabled],input[type=reset][disabled],input[type=submit][disabled]{cursor:default;opacity:.5;cursor:not-allowed}.button:enabled:hover,.button:focus,button:enabled:hover,button:focus,input[type=button]:enabled:hover,input[type=button]:focus,input[type=reset]:enabled:hover,input[type=reset]:focus,input[type=submit]:enabled:hover,input[type=submit]:focus{background:var(--nc-lk-2)}code,kbd,pre,samp{font-family:var(--nc-font-mono)}code,kbd,pre,samp{background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px;padding:3px 6px;font-size:.9em}kbd{border-bottom:3px solid var(--nc-bg-3)}pre{padding:1rem 1.4rem;max-width:100%;overflow:auto}pre code{background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}code pre{display:inline;background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}details{padding:.6rem 1rem;background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px}summary{cursor:pointer;font-weight:700}details[open]{padding-bottom:.75rem}details[open] summary{margin-bottom:6px}details[open]>:last-child{margin-bottom:0}dt{font-weight:700}dd::before{content:"→ "}hr{border:0;border-bottom:1px solid var(--nc-bg-3);margin:1rem auto}fieldset{margin-top:1rem;padding:2rem;border:1px solid var(--nc-bg-3);border-radius:4px}legend{padding:auto .5rem}table{border-collapse:collapse;width:100%}td,th{text-align:left;padding:.5rem}th{font-weight:400;border-bottom:1px solid var(--nc-tx-1)}table caption{font-weight:700;margin-bottom:.5rem}textarea{max-width:100%}ol,ul{padding-left:2rem}li{margin-top:.4rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}mark{padding:3px 6px;background:var(--nc-ac-1);color:var(--nc-ac-tx)}input,select,textarea{padding:6px 12px;margin-bottom:.5rem;background:var(--nc-bg-2);color:var(--nc-tx-2);border:1px solid var(--nc-bg-3);border-radius:4px;box-shadow:none;box-sizing:border-box}img{max-width:100%}/*!
 * prism.js tomorrow night eighties for javascript, coffeescript, css and html
 * based on https://github.com/chriskempson/tomorrow-theme
 * Author: Rose Pritchard
 */code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.post-subheader{font-style:italic;color:var(--nc-tx-3)}.post-date{font-family:var(--nc-font-mono)}ul.post-list{list-style-type:none;padding-left:0}@media screen and (max-width:600px){.post-date{display:none}ul.post-list{list-style-type:disc;padding-left:0}}.formatted-tag{font-family:var(--nc-font-mono);opacity:.6}.not-found{text-align:center}#not-found-canvas{z-index:-1}a{text-decoration:none}pre{max-height:50rem}img{display:block;margin-left:auto;margin-right:auto}ul{list-style-type:circle}.header-anchor{font-size:small}.hidden{display:none}/*!
 * Inspired by material theme https://www.material-theme.com/docs/reference/color-palette/
 */:root{--is-light-theme:1;--nc-l-tx-1:#546e7a;--nc-l-tx-2:#161d21;--nc-l-tx-3:#6d7169;--nc-l-bg-1:#f4f4f4;--nc-l-bg-2:#eae8e8;--nc-l-bg-3:#fafafa;--nc-l-lk-1:#176166;--nc-l-lk-2:#528aff;--nc-l-lk-tx:#f3f4f5;--nc-l-ac-1:#91b859;--nc-l-ac-tx:#fafafa;--nc-d-tx-1:#ffffff;--nc-d-tx-2:#b7b7b7;--nc-d-tx-3:#8a8d87;--nc-d-bg-1:#1e272c;--nc-d-bg-2:#161d21;--nc-d-bg-3:#263238;--nc-d-lk-1:#5e92ff;--nc-d-lk-2:#99b2e8;--nc-d-lk-tx:#2e3c43;--nc-d-ac-1:#c3e88d;--nc-d-ac-tx:#263238}@media (prefers-color-scheme:dark){:root{--is-light-theme:0;--nc-tx-1:var(--nc-d-tx-1);--nc-tx-2:var(--nc-d-tx-2);--nc-tx-3:var(--nc-d-tx-3);--nc-bg-1:var(--nc-d-bg-1);--nc-bg-2:var(--nc-d-bg-2);--nc-bg-3:var(--nc-d-bg-3);--nc-lk-1:var(--nc-d-lk-1);--nc-lk-2:var(--nc-d-lk-2);--nc-lk-tx:var(--nc-d-lk-tx);--nc-ac-1:var(--nc-d-ac-1);--nc-ac-tx:var(--nc-d-ac-tx)}}.nav-link{text-decoration:none}.nav-link.active{color:var(--nc-lk-2)}.hamburger{width:20px;height:2px;box-shadow:inset 0 0 0 32px,0 -6px,0 6px;margin:16px 7px;display:block}.topnav .icon{display:none}@media screen and (max-width:600px){.topnav span.nav-item:not(.active){display:none}.topnav span.icon{float:right;display:block;right:0;top:0;color:var(--nc-lk-1)}.topnav .nav-separator{display:none}.topnav.responsive{position:relative}.topnav.responsive span.icon{position:absolute;right:0;top:0;color:var(--nc-lk-2)}.topnav.responsive span{float:none;display:block;text-align:left}.topnav.responsive span.nav-item:not(.active){display:block}}.comment{--comment-bg:#e3efee;--comment-d-bg:#2a4765;margin-top:20px;padding:5px}.add-comment-btn{float:right}.comment-header{background:var(--comment-bg);padding-right:100px;padding-left:10px;border-top-left-radius:10px;border-top-right-radius:10px;padding:5px}.comment-content{border:2px solid var(--comment-bg);border-bottom-left-radius:10px;border-bottom-right-radius:10px}.comment-text{padding:10px}.comment-reactions{border-top:2px solid var(--comment-bg);padding:5px}.comment-reaction-item{padding-right:10px;padding-left:10px;border-right:2px solid var(--comment-bg)}@media (prefers-color-scheme:dark){.comment{--comment-bg:var(--comment-d-bg)}}kbd{--black-800:#242729;--white:#fff;--black-075:#e4e6e8;--black-300:#9fa6ad;--s-prose-line-height:1.5;--ff-sans:Arial,"Helvetica Neue",Helvetica,sans-serif}@media (prefers-color-scheme:dark){kbd{--black-800:#e7e8eb;--white:#2d2d2d;--black-075:#404345;--black-300:#7d848d}}kbd{display:inline-block;margin:0 .1em;padding:.1em .6em;font-family:var(--nc-font-sans);font-size:11px;line-height:var(--s-prose-line-height);color:var(--black-800);text-shadow:0 1px 0 var(--white);background-color:var(--black-075);border:1px solid var(--black-300);border-radius:3px;box-shadow:0 1px 1px rgba(12,13,14,.15),inset 0 1px 0 0 #fff;overflow-wrap:break-word}.top-link{transition:all .25s ease-in-out;position:fixed;bottom:0;right:0;display:inline-flex;cursor:pointer;align-items:center;justify-content:center;margin:0 3em 3em 0;border-radius:50%;padding:.25em;width:80px;height:80px;background-color:var(--nc-bg-2)}.top-link.show{visibility:visible;opacity:1}.top-link.hide{visibility:hidden;opacity:0}.top-link svg{fill:var(--nc-lk-1);width:24px;height:12px}.top-link:hover{background-color:var(--nc-bg-0)}.top-link:hover svg{fill:var(--nc-lk-2)}.screen-reader-text{position:absolute;clip-path:inset(50%);margin:-1px;border:0;padding:0;width:1px;height:1px;overflow:hidden;word-wrap:normal!important;clip:rect(1px,1px,1px,1px)}.screen-reader-text:focus{display:block;top:5px;left:5px;z-index:100000;clip-path:none;background-color:#eee;padding:15px 23px 14px;width:auto;height:auto;text-decoration:none;line-height:normal;color:#444;font-size:1em;clip:auto!important}</style></head><body><header><h1>The stuff I do</h1><nav class="topnav" id="header-navbar" onclick="navbarToggle()"><span class="nav-item active"><a class="nav-link active" href="#" onclick='navbarNavigate("/")'>Home</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/projects/")'>Projects</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/music/")'>Music</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/notes/")'>Notes</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/about/")'>About</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/ring/")'>Ring</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/feed.xml")'>RSS</a> <i class="nav-separator">♢</i> </span><span class="nav-item" onclick="toggleDarkTheme()"><i class="fas fa-adjust"></i></span> <span class="icon hamburger"></span></nav></header><div class="content-container"><h2>Highlighting yanked text with pure vimscript</h2><p class="post-subheader"><span id="post_date"></span> - 1389 words - <span id="commentCounter"></span> <span id="comment_word"></span></p><p><a href="/">← Posts</a></p><p>A few days ago I saw <a href="https://blog.kdheepak.com/three-built-in-neovim-features.html#highlight-yanked-text" target="_blank" rel="noopener noreferrer">a blog post</a> showing a built-in way to highlight yanked text on neovim. The author uses neovim's lua integration combined with the <a href="https://neovim.io/doc/user/autocmd.html#TextYankPost" target="_blank" rel="noopener noreferrer"><code>:h TextYankPost</code></a> autocommand event:</p><pre class="language-vim"><code class="language-vim">augroup highlightYankedText<br>    <span class="token builtin">autocmd</span><span class="token operator">!</span><br>    <span class="token builtin">autocmd</span> TextYankPost <span class="token operator">*</span>  <span class="token keyword">silent</span><span class="token operator">!</span> lua require<span class="token string">'vim.highlight'</span><span class="token operator">.</span><span class="token function">on_yank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>augroup END</code></pre><p>I liked the idea of having visual feedback on my yanks but I am still reluctant to use the lua integration. Despite all the bad things you can read about vimscript online I like to keep my configuration in pure vimscript as much as possible mostly for portability reasons.</p><p>So I decided to <s>reinvent the wheel</s> replicate this behavior with pure vimscript! This was interesting to do because it involves playing with patterns and matches which are the basic building bricks of Vim's highlighting function. And because these are not tools that I need to use regularly so I am not very familiar with them.</p><p>So here is the result I am looking for: In this screen cap you can see me first yanking the word &quot;filetype&quot; with <code>yiw</code>, then the full line with <code>yy</code> and finally several lines:</p><p><img src="./flash_yanked_text.gif" alt="Demo of highlighted text"/></p><p>In this article I will to relate the main steps I followed to get this feature working. To keep it readable I will not follow all the best practices or go into all the details to make it flawless but I hope this kind of iteration process can help new vimmers to get into vimscript by demonstrating some useful concepts.</p><h3 id="a-reminder-on-how-to-highlight-stuff" tabindex="-1">A reminder on how to highlight stuff <a class="header-anchor" href="#a-reminder-on-how-to-highlight-stuff">🔗</a></h3><p>First a bit of Vim terminology about highlighting:</p><ul><li><p>A <code>pattern</code> is basically a regular expression which can be used to search for some text.</p><p>Patterns can be as simple as plain text (e.g. <code>/TODO</code> ) or complex regexes with a lot of items as described in <a href="http://vimhelp.appspot.com/pattern.txt.html#pattern" target="_blank" rel="noopener noreferrer"><code>:h pattern</code></a>.</p></li><li><p>A <code>highlighting group</code> is a named group of highlighting instructions.</p><p>The <a href="http://vimhelp.appspot.com/syntax.txt.html#%3Ahighlight" target="_blank" rel="noopener noreferrer"><code>:highlight</code></a> command allows to list the existing groups when given no arguments. It also allows to create new groups or get details about the existing ones. By default both Vim and Neovim have an <code>IncSearch</code> highlighting group which we will reuse to highlight our text. You can see what it looks like on your system with the command <code>:highlight IncSearch</code></p></li><li><p>Finally a <code>match</code> is a way to tell Vim to highlight a specific pattern using a specific highlighting group.</p><p>A match can be created with <a href="http://vimhelp.appspot.com/eval.txt.html#matchadd%28%29" target="_blank" rel="noopener noreferrer"><code>matchadd()</code></a>. The first argument is the name of an highlighting group as shown in the result of <code>:highlight</code> and the second argument is a pattern:</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">'TODO'</span><span class="token punctuation">)</span></code></pre><p>To delete a match simply use the ID returned by the previous command. Note that this command only works in the window where the match was created, this will be important later on.</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">call</span> <span class="token function">matchdelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></code></pre></li></ul><h3 id="making-the-pattern-work" tabindex="-1">Making the pattern work <a class="header-anchor" href="#making-the-pattern-work">🔗</a></h3><p>The first step to highlight yanked text is to be able to match the last yanked text. Fortunately, <a href="http://vimhelp.appspot.com/motion.txt.html#%27%5b" target="_blank" rel="noopener noreferrer"><code>:h '[</code></a> tells us that Vim has two marks <code>'[</code> and <code>']</code> which are positioned on the first and last characters of the previously changed or yanked text.</p><p>And <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c%25%27m" target="_blank" rel="noopener noreferrer"><code>:h /\%'m</code></a> tells us that we can use such marks in a pattern, so my first attempt looked like this:</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">"\\%'\\[.*\\%']"</span><span class="token punctuation">)</span></code></pre><p>The main items of the pattern are the following:</p><ul><li><code>'[</code> is the mark I mentioned before but <code>[</code> being a special character (used in <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5b%5d" target="_blank" rel="noopener noreferrer"><code>:h /[]</code></a>) it needs to be escaped hence <code>'\\[</code>. Note that each <code>\</code> needs to be escaped to be used in the command.</li><li>Given this previous point, <code>\\%'\\[</code> is the way to use <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c%25%27m" target="_blank" rel="noopener noreferrer"><code>:h /\%'m</code></a> with the <code>'[</code> mark, matching the beginning of the previously yanked text.</li><li><code>.*</code> allows to match any characters any number of time.</li><li><code>\\%']</code> is the equivalent of the first item with the <code>']</code> mark. Note that here <code>]</code> doesn't need to be escaped since there is no risk of confusion with <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5b%5d" target="_blank" rel="noopener noreferrer"><code>:h /[]</code></a>.</li></ul><p>This is a great first attempt which kind of works on some simple cases but fails when yanking text on several lines. This is because the <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f." target="_blank" rel="noopener noreferrer"><code>.</code></a> atom doesn't match end of lines characters, so we need to use <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c_." target="_blank" rel="noopener noreferrer"><code>\_.</code></a> instead:</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">"\\%'\\[\\_.*\\%']"</span><span class="token punctuation">)</span></code></pre><p>That is better but still not completely working, for example the first and last characters of the yanked text are not highlighted. That's the moment where we turn to the doc and read a bit more what <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c%25%27m" target="_blank" rel="noopener noreferrer"><code>:h /\%'m</code></a> has to say, particularly this:</p><pre><code>Example, to highlight the text from mark 's to 'e:
	/.\%&gt;'s.*\%&lt;'e..
Note that two dots are required to include mark 'e in the match.  That
is because &quot;\%&lt;'e&quot; matches at the character before the 'e mark, and
since it's a |/zero-width| match it doesn't include that character.
</code></pre><p>Easy peasy, let's reuse the same thing but with our marks <code>'[</code> and <code>']</code>:</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span></code></pre><p><em>Important note</em>: Some of this escaping could be greatly simplified using a different magic mode but it's not my point here. For more information on magic in Vim see <a href="http://vimhelp.appspot.com/pattern.txt.html#%2fmagic" target="_blank" rel="noopener noreferrer"><code>:h /magic</code></a></p><p>So after a few tests yanking some random text, using <code>matchadd</code> to highlight it and <code>matchdelete</code> to remove the highlighting I am satisfied with the result, it is then time to automatically highlight our text.</p><h3 id="using-the-pattern-automatically" tabindex="-1">Using the pattern automatically <a class="header-anchor" href="#using-the-pattern-automatically">🔗</a></h3><p>Vim provides since it <a href="https://github.com/vim/vim/commit/7e1652c63c96585b9e2235c195a3c322b1f11595" target="_blank" rel="noopener noreferrer">patch 8.0.1394</a> the <a href="http://vimhelp.appspot.com/autocmd.txt.html#TextYankPost" target="_blank" rel="noopener noreferrer"><code>:h TextYankPost</code></a> autocommand event which triggers just after a yank or deleting command. So our first step is to create a function triggered by this event:</p><pre class="language-vim"><code class="language-vim">augroup highlightYankedText<br>    <span class="token builtin">autocmd</span><span class="token operator">!</span><br>    <span class="token builtin">autocmd</span> TextYankPost <span class="token operator">*</span> <span class="token keyword">call</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>augroup END<br><br><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span><br><span class="token keyword">endfunction</span></code></pre><p>As you can see I put my autocommand in an <a href="http://vimhelp.appspot.com/autocmd.txt.html#%3Aaugroup" target="_blank" rel="noopener noreferrer"><code>augroup</code></a> because <strong><em>every time you use an autocommand without an augroup you make a kitten cry</em></strong> 😿... and <a href="https://vi.stackexchange.com/q/9455/1841" target="_blank" rel="noopener noreferrer">for other reasons too</a>.</p><p>That is great! Each time we yank some text it gets highlighted... but then it remains highlighted indefinitely. So let's simply use a timer to delete the match we just created. Note that the function puts the id of the newly created match in a global variable which is kind of ugly but pretty pratical to access it in the <code>DeleteTemporaryMatch()</code> function.</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token function">timer_start</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'DeleteTemporaryMatch'</span><span class="token punctuation">)</span><br><span class="token keyword">endfunction</span><br><br><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">DeleteTemporaryMatch</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token function">matchdelete</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>idTemporaryHighlight<span class="token punctuation">)</span><br><span class="token keyword">endfunction</span></code></pre><h3 id="making-the-feature-reliable" tabindex="-1">Making the feature reliable <a class="header-anchor" href="#making-the-feature-reliable">🔗</a></h3><p>The previous code kind of works but some edge cases are problematic:</p><ul><li>When I yank two different texts too quickly sometimes the <code>DeleteTemporaryMatch()</code> function doesn't have the time to delete the previous match.</li><li>More importantly, when I switch to another window just after yanking some text, <code>deletematches()</code> fails because the matches id are local to a window.</li></ul><p>So let's put the ids in a list, with the window id where they were created:</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">'g:yankedTextMatches'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token keyword">let</span> g<span class="token punctuation">:</span>yankedTextMatches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>    <span class="token keyword">endif</span><br><br>    <span class="token keyword">let</span> matchId <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> windowId <span class="token operator">=</span> <span class="token function">winnr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">call</span> <span class="token function">add</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>yankedTextMatches<span class="token punctuation">,</span> <span class="token punctuation">[</span>windowId<span class="token punctuation">,</span> matchId<span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token function">timer_start</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'DeleteTemporaryMatch'</span><span class="token punctuation">)</span><br><span class="token keyword">endfunction</span></code></pre><p>Now <code>DeleteTemporaryMatch()</code> can simply dequeue the <code>g:yankedTextMatches</code> list and remove the matches on the corresponding window:</p><pre class="language-vim"><code class="language-vim"><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">DeleteTemporaryMatch</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><br>    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>yankedTextMatches<span class="token punctuation">)</span><br>        <span class="token keyword">let</span> <span class="token keyword">match</span> <span class="token operator">=</span> <span class="token function">remove</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>yankedTextMatches<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><br>        <span class="token keyword">let</span> windowID <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>        <span class="token keyword">let</span> matchID <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br><br>        <span class="token keyword">try</span><br>            <span class="token keyword">call</span> <span class="token function">matchdelete</span><span class="token punctuation">(</span>matchID<span class="token punctuation">,</span> windowID<span class="token punctuation">)</span><br>        <span class="token keyword">endtry</span><br>    <span class="token keyword">endwhile</span><br><span class="token keyword">endfunction</span></code></pre><p>For good measures the call to <code>matchdelete()</code> is enclosed in a <code>try...catch</code> block, just in case something else fails and I don't want to be bothered with an error message.</p><p>And here we are! With about 20 lines of vimscript we reimplemented the highlight yanked text feature! Well, kind of, there are some edge cases which needs a bit more work for this to work flawlessly, especially the cases where the user changes of window before <code>DeleteTemporaryMatch()</code> is called.</p><h3 id="turning-it-into-a-plugin" tabindex="-1">Turning it into a plugin <a class="header-anchor" href="#turning-it-into-a-plugin">🔗</a></h3><p>Now that we have a code working properly, we could leave that in our <code>.vimrc</code> and live happily with that... But it would be even better to make it a plugin! This way the functions will be loaded only when necessary (and thus, avoid increasing your startup time), we can get rid of global variables and just have a clean line in our <code>.vimrc</code>, and while we are at it we could create a variable to control how long the flash should last... And that's actually what I did!</p><p>I think the specific of how I turned my code into a plugin would make this post way too long, so the result can be found <a href="https://github.com/statox/vim-flash-yanked-text" target="_blank" rel="noopener noreferrer">on my github</a> and I am of course available to answer any questions you could have about it.</p><p><a href="/">← Posts</a></p><hr/><p></p><h3>Related posts</h3><p>Posts in the same category: <span class="formatted-tag">[vim]</span></p><ul><li><span class="post-date">Sep 2017</span> <a class="post-link" href="/posts/2017/09/vim_colorscheme_changer/">Changing my Vim colorscheme depending on the time of the day</a></li><li><span class="post-date">Feb 2021</span> <a class="post-link" href="/posts/2021/02/stepping-down-vi-se/">Reaching 1.2m readers and stepping down from my moderator position on vi.se</a></li></ul><hr/><comments><h3>Comments</h3><a class="add-comment-btn" href="https://github.com/statox/blog-comments/issues/9#new_comment_field" target="_blank" rel="noopener noreferrer"><button>Comment on Github</button></a><br/></comments><script>const reactionEmojis={laugh:"&#x1F600","+1":"&#x1F44D","-1":"&#x1F44E",hooray:"&#x1F389",confused:"&#x1F615",heart:"&#x2665",rocket:"&#x1F680",eyes:"&#x1F440"};function domReady(e){document.addEventListener("DOMContentLoaded",e),"interactive"!==document.readyState&&"complete"!==document.readyState||e()}function countReactions(e){const t={};return e.forEach(e=>{t[e.content]?t[e.content]++:t[e.content]=1}),t}function formatReactions(e){if(!e.length)return"";const n=countReactions(e);return Object.keys(n).reduce((e,t)=>{return e+'<span class="comment-reaction-item">'+(reactionEmojis[t]||`:${t}:`)+"&nbsp"+n[t]+"</span>"},"")}function appendComments(e){const o=document.querySelector("comments"),t=document.getElementById("commentCounter");t&&(t.innerText=e.length||0),e&&e.forEach&&0!==e.length?e.forEach(function(e){var t=formatCommentDate(new Date(e.created_at)),t=`<a href="${e.user.html_url} rel="noopener noreferrer" target="_blank">${e.user.login}</a>`+" on "+`<a href="${e.html_url}" rel="noopener noreferrer" target="_blank">${t}</a>`;let n="";n+='<div class="comment">',n+='    <div class="comment-header">'+t+"</div>",n+='    <div class="comment-content">',n+='        <div class="comment-text">'+e.body_html+"</div>",0<e.reactions.length&&(n+='        <div class="comment-reactions">'+formatReactions(e.reactions)+"</div>"),n+="    </div>",n+="</div>",o.insertAdjacentHTML("beforeend",n)}):o.insertAdjacentHTML("beforeend","<p>No comments yet.</p>")}async function getComments(e){const t=await fetch(`https://api.github.com/repos/statox/blog-comments/issues/${e}/comments`,{method:"GET",mode:"cors",cache:"no-cache",headers:{Accept:"application/vnd.github.v3.html+json"}});return t.json()}async function getReactions(e){const t=await fetch(`https://api.github.com/repos/statox/blog-comments/issues/comments/${e}/reactions`,{method:"GET",mode:"cors",cache:"no-cache",headers:{Accept:"application/vnd.github.squirrel-girl-preview+json"}});return t.json()}function formatCommentDate(e){return`${e.getDate()}/${e.getUTCMonth()+1}/${e.getFullYear()}`}function setupCommentsInPage(t){domReady(async()=>{const e=await getComments(t);await Promise.all(e.map(async e=>{e.reactions=await getReactions(e.id)})),appendComments(e)})}function adaptToScreenSize(e){const t=new Date("Sat Jul 04 2020 00:00:00 GMT+0000 (Coordinated Universal Time)");let n=t.toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"}),o="comments";e.matches&&(n=t.toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"}),o="💬"),document.getElementById("post_date").textContent=n,document.getElementById("comment_word").textContent=o}setupCommentsInPage(9);var x=window.matchMedia("(max-width: 500px)");adaptToScreenSize(x),x.addListener(adaptToScreenSize)</script></div><script data-goatcounter="https://statoxblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css"/><script src="https://kit.fontawesome.com/cc32401bee.js" crossorigin="anonymous"></script></body></html>