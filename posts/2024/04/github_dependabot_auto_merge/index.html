<!doctype html><html lang="en"><title>Automatically merging Dependabot PRs on Github - The stuff I do</title><meta name="description" content="A personal blog where I write about my side projects"/><meta name="robots" content="index,follow"/><meta name="author" content="[object Object]"/><link rel="canonical" href="https://www.statox.fr/posts/2024/04/github_dependabot_auto_merge/"/><meta property="og:title" content="Automatically merging Dependabot PRs on Github - The stuff I do"/><meta property="og:type" content="article"/><meta property="og:url" content="https://www.statox.fr/posts/2024/04/github_dependabot_auto_merge/"/><meta property="og:description" content="A personal blog where I write about my side projects"/><meta name="twitter:card" content="summary"/><meta name="twitter:url" content="https://www.statox.fr/posts/2024/04/github_dependabot_auto_merge/"/><meta name="twitter:title" content="Automatically merging Dependabot PRs on Github - The stuff I do"/><meta name="twitter:description" content="A personal blog where I write about my side projects"/><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Automatically merging Dependabot PRs on Github</title><meta name="description" content="A personal blog where I write about my side projects"/><meta name="keywords" content="statox blog"/><meta name="generator" content="Eleventy"/><meta property="og:title" content="The stuff I do"/><meta property="og:url" content="https://www.statox.fr"/><meta property="og:description" content="A personal blog where I write about my side projects"/><meta property="og:type" content="website"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5"/><script>const bigScreenQuery=window.matchMedia("(max-width: 600px)");let bigScreen=!bigScreenQuery.matches;function navbarNavigate(e){var t=document.getElementById("header-navbar");(bigScreen||t.className.includes("responsive"))&&(document.location.pathname=e)}function navbarToggle(){var e=document.getElementById("header-navbar");"topnav"===e.className?e.className+=" responsive":e.className="topnav"}function toggleDarkTheme(){var e,t,n="1"===getComputedStyle(document.documentElement).getPropertyValue("--is-light-theme");const o=n?"-d":"-l";for({current:e,target:t}of["--nc-tx-1","--nc-tx-2","--nc-tx-3","--nc-bg-0","--nc-bg-1","--nc-bg-2","--nc-bg-3","--nc-lk-1","--nc-lk-2","--nc-lk-tx","--nc-ac-1","--nc-ac-tx"].map(e=>({current:e,target:e.slice(0,4)+o+e.slice(4)}))){var a=getComputedStyle(document.documentElement).getPropertyValue(t);document.documentElement.style.setProperty(e,a)}document.documentElement.style.setProperty("--is-light-theme",n?"0":"1"),writeLightThemeCookie(n?"0":"1")}function domReady(e){document.addEventListener("DOMContentLoaded",e),"interactive"!==document.readyState&&"complete"!==document.readyState||e()}function readLightThemeCookie(){return localStorage.getItem("lighttheme")}function writeLightThemeCookie(e){if("0"!==e&&"1"!==e)throw new Error("Invalid value for cookie lighttheme",e);localStorage.setItem("lighttheme",e)}bigScreenQuery.addListener(e=>bigScreen=!e.matches),domReady(()=>{var e=readLightThemeCookie();e&&getComputedStyle(document.documentElement).getPropertyValue("--is-light-theme")!==e&&toggleDarkTheme()})</script><style>/*!
 * new.css framework forked from https://github.com/xz/new.css
 */:root{--nc-font-sans:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--nc-font-mono:Consolas,monaco,"Ubuntu Mono","Liberation Mono","Courier New",Courier,monospace;--is-light-theme:1;--nc-l-tx-1:#000000;--nc-l-tx-2:#1a1a1a;--nc-l-tx-3:#6d7169;--nc-l-bg-0:#cecece;--nc-l-bg-1:#ffffff;--nc-l-bg-2:#f6f8fa;--nc-l-bg-3:#e5e7eb;--nc-l-lk-1:#0070f3;--nc-l-lk-2:#0366d6;--nc-l-lk-tx:#ffffff;--nc-l-ac-1:#79ffe1;--nc-l-ac-tx:#0c4047;--nc-d-tx-1:#ffffff;--nc-d-tx-2:#eeeeee;--nc-d-tx-3:#8a8d87;--nc-d-bg-0:#13191c;--nc-d-bg-1:#000000;--nc-d-bg-2:#111111;--nc-d-bg-3:#222222;--nc-d-lk-1:#3291ff;--nc-d-lk-2:#0070f3;--nc-d-lk-tx:#ffffff;--nc-d-ac-1:#7928ca;--nc-d-ac-tx:#ffffff;--nc-tx-1:var(--nc-l-tx-1);--nc-tx-2:var(--nc-l-tx-2);--nc-tx-3:var(--nc-l-tx-3);--nc-bg-0:var(--nc-l-bg-0);--nc-bg-1:var(--nc-l-bg-1);--nc-bg-2:var(--nc-l-bg-2);--nc-bg-3:var(--nc-l-bg-3);--nc-lk-1:var(--nc-l-lk-1);--nc-lk-2:var(--nc-l-lk-2);--nc-lk-tx:var(--nc-l-lk-tx);--nc-ac-1:var(--nc-l-ac-1);--nc-ac-tx:var(--nc-l-ac-tx)}@media (prefers-color-scheme:dark){:root{--is-light-theme:0;--nc-tx-1:var(--nc-d-tx-1);--nc-tx-2:var(--nc-d-tx-2);--nc-bg-0:var(--nc-d-bg-0);--nc-bg-1:var(--nc-d-bg-1);--nc-bg-2:var(--nc-d-bg-2);--nc-bg-3:var(--nc-d-bg-3);--nc-lk-1:var(--nc-d-lk-1);--nc-lk-2:var(--nc-d-lk-2);--nc-lk-tx:var(--nc-d-lk-tx);--nc-ac-1:var(--nc-d-ac-1);--nc-ac-tx:var(--nc-d-ac-tx)}}*{margin:0;padding:0}address,area,article,aside,audio,blockquote,datalist,details,dl,fieldset,figure,form,iframe,img,input,meter,nav,ol,optgroup,option,output,p,pre,progress,ruby,section,table,textarea,ul,video{margin-bottom:1rem}button,html,input,select{font-family:var(--nc-font-sans)}body{margin:0 auto;max-width:750px;padding:2rem;border-radius:6px;overflow-x:hidden;word-break:break-word;overflow-wrap:break-word;background:var(--nc-bg-1);color:var(--nc-tx-2);font-size:1.03rem;line-height:1.5}::selection{background:var(--nc-ac-1);color:var(--nc-ac-tx)}h1,h2,h3,h4,h5,h6{line-height:1;color:var(--nc-tx-1);padding-top:.875rem}h1,h2,h3{color:var(--nc-tx-1);padding-bottom:2px;margin-bottom:8px;border-bottom:1px solid var(--nc-bg-2)}h4,h5,h6{margin-bottom:.3rem}h1{font-size:2.25rem}h2{font-size:1.85rem}h3{font-size:1.55rem}h4{font-size:1.25rem}h5{font-size:1rem}h6{font-size:.875rem}a{color:var(--nc-lk-1)}a:hover{color:var(--nc-lk-2)}abbr:hover{cursor:help}blockquote{padding:1.5rem;background:var(--nc-bg-2);border-left:5px solid var(--nc-bg-3)}abbr{cursor:help}blockquote :last-child{padding-bottom:0;margin-bottom:0}header{background:var(--nc-bg-2);border-bottom:1px solid var(--nc-bg-3);padding:2rem 1.5rem;margin:-2rem calc(0px - (50vw - 50%)) 2rem;padding-left:calc(50vw - 50%);padding-right:calc(50vw - 50%)}header h1,header h2,header h3{padding-bottom:0;border-bottom:0}header>:first-child{margin-top:0;padding-top:0}header>:last-child{margin-bottom:0}a button,button,input[type=button],input[type=reset],input[type=submit]{font-size:1rem;display:inline-block;padding:6px 12px;text-align:center;text-decoration:none;white-space:nowrap;background:var(--nc-lk-1);color:var(--nc-lk-tx);border:0;border-radius:4px;box-sizing:border-box;cursor:pointer;color:var(--nc-lk-tx)}a button[disabled],button[disabled],input[type=button][disabled],input[type=reset][disabled],input[type=submit][disabled]{cursor:default;opacity:.5;cursor:not-allowed}.button:enabled:hover,.button:focus,button:enabled:hover,button:focus,input[type=button]:enabled:hover,input[type=button]:focus,input[type=reset]:enabled:hover,input[type=reset]:focus,input[type=submit]:enabled:hover,input[type=submit]:focus{background:var(--nc-lk-2)}code,kbd,pre,samp{font-family:var(--nc-font-mono)}code,kbd,pre,samp{background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px;padding:3px 6px;font-size:.9em}kbd{border-bottom:3px solid var(--nc-bg-3)}pre{padding:1rem 1.4rem;max-width:100%;overflow:auto}pre code{background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}code pre{display:inline;background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}details{padding:.6rem 1rem;background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px}summary{cursor:pointer;font-weight:700}details[open]{padding-bottom:.75rem}details[open] summary{margin-bottom:6px}details[open]>:last-child{margin-bottom:0}dt{font-weight:700}dd::before{content:"→ "}hr{border:0;border-bottom:1px solid var(--nc-bg-3);margin:1rem auto}fieldset{margin-top:1rem;padding:2rem;border:1px solid var(--nc-bg-3);border-radius:4px}legend{padding:auto .5rem}table{border-collapse:collapse;width:100%}td,th{text-align:left;padding:.5rem}th{font-weight:400;border-bottom:1px solid var(--nc-tx-1)}table caption{font-weight:700;margin-bottom:.5rem}textarea{max-width:100%}ol,ul{padding-left:2rem}li{margin-top:.4rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}mark{padding:3px 6px;background:var(--nc-ac-1);color:var(--nc-ac-tx)}input,select,textarea{padding:6px 12px;margin-bottom:.5rem;background:var(--nc-bg-2);color:var(--nc-tx-2);border:1px solid var(--nc-bg-3);border-radius:4px;box-shadow:none;box-sizing:border-box}img{max-width:100%}/*!
 * prism.js tomorrow night eighties for javascript, coffeescript, css and html
 * based on https://github.com/chriskempson/tomorrow-theme
 * Author: Rose Pritchard
 */code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.formatted-tag{font-family:var(--nc-font-mono);opacity:.6}.not-found{text-align:center}#not-found-canvas{z-index:-1}a{text-decoration:none}pre{max-height:50rem}img{display:block;margin-left:auto;margin-right:auto}ul{list-style-type:circle}.header-anchor{font-size:small}.hidden{display:none}/*!
 * Inspired by material theme https://www.material-theme.com/docs/reference/color-palette/
 */:root{--is-light-theme:1;--nc-l-tx-1:#546e7a;--nc-l-tx-2:#161d21;--nc-l-tx-3:#6d7169;--nc-l-bg-1:#f4f4f4;--nc-l-bg-2:#eae8e8;--nc-l-bg-3:#fafafa;--nc-l-lk-1:#176166;--nc-l-lk-2:#528aff;--nc-l-lk-tx:#f3f4f5;--nc-l-ac-1:#91b859;--nc-l-ac-tx:#fafafa;--nc-d-tx-1:#ffffff;--nc-d-tx-2:#b7b7b7;--nc-d-tx-3:#8a8d87;--nc-d-bg-1:#1e272c;--nc-d-bg-2:#161d21;--nc-d-bg-3:#263238;--nc-d-lk-1:#5e92ff;--nc-d-lk-2:#99b2e8;--nc-d-lk-tx:#2e3c43;--nc-d-ac-1:#c3e88d;--nc-d-ac-tx:#263238}@media (prefers-color-scheme:dark){:root{--is-light-theme:0;--nc-tx-1:var(--nc-d-tx-1);--nc-tx-2:var(--nc-d-tx-2);--nc-tx-3:var(--nc-d-tx-3);--nc-bg-1:var(--nc-d-bg-1);--nc-bg-2:var(--nc-d-bg-2);--nc-bg-3:var(--nc-d-bg-3);--nc-lk-1:var(--nc-d-lk-1);--nc-lk-2:var(--nc-d-lk-2);--nc-lk-tx:var(--nc-d-lk-tx);--nc-ac-1:var(--nc-d-ac-1);--nc-ac-tx:var(--nc-d-ac-tx)}}.nav-link{text-decoration:none}.nav-link.active{color:var(--nc-lk-2)}.hamburger{width:20px;height:2px;box-shadow:inset 0 0 0 32px,0 -6px,0 6px;margin:16px 7px;display:block}.topnav .icon{display:none}@media screen and (max-width:600px){.topnav span.nav-item:not(.active){display:none}.topnav span.icon{float:right;display:block;right:0;top:0;color:var(--nc-lk-1)}.topnav .nav-separator{display:none}.topnav.responsive{position:relative}.topnav.responsive span.icon{position:absolute;right:0;top:0;color:var(--nc-lk-2)}.topnav.responsive span{float:none;display:block;text-align:left}.topnav.responsive span.nav-item:not(.active){display:block}}.comment{--comment-bg:#e3efee;--comment-d-bg:#2a4765;margin-top:20px;padding:5px}.add-comment-btn{float:right}.comment-header{background:var(--comment-bg);padding-right:100px;padding-left:10px;border-top-left-radius:10px;border-top-right-radius:10px;padding:5px}.comment-content{border:2px solid var(--comment-bg);border-bottom-left-radius:10px;border-bottom-right-radius:10px}.comment-text{padding:10px}.comment-reactions{border-top:2px solid var(--comment-bg);padding:5px}.comment-reaction-item{padding-right:10px;padding-left:10px;border-right:2px solid var(--comment-bg)}@media (prefers-color-scheme:dark){.comment{--comment-bg:var(--comment-d-bg)}}kbd{--black-800:#242729;--white:#fff;--black-075:#e4e6e8;--black-300:#9fa6ad;--s-prose-line-height:1.5;--ff-sans:Arial,"Helvetica Neue",Helvetica,sans-serif}@media (prefers-color-scheme:dark){kbd{--black-800:#e7e8eb;--white:#2d2d2d;--black-075:#404345;--black-300:#7d848d}}kbd{display:inline-block;margin:0 .1em;padding:.1em .6em;font-family:var(--nc-font-sans);font-size:11px;line-height:var(--s-prose-line-height);color:var(--black-800);text-shadow:0 1px 0 var(--white);background-color:var(--black-075);border:1px solid var(--black-300);border-radius:3px;box-shadow:0 1px 1px rgba(12,13,14,.15),inset 0 1px 0 0 #fff;overflow-wrap:break-word}.top-link{transition:all .25s ease-in-out;position:fixed;bottom:0;left:10;display:inline-flex;cursor:pointer;align-items:center;justify-content:center;margin:0 3em 3em 0;border-radius:50%;padding:.25em;width:40px;height:40px;background-color:var(--nc-bg-2)}.top-link.show{visibility:visible;opacity:1}.top-link.hide{visibility:hidden;opacity:0}.top-link svg{fill:var(--nc-lk-1);width:24px;height:12px}.top-link:hover{background-color:var(--nc-bg-0)}.top-link:hover svg{fill:var(--nc-lk-2)}.screen-reader-text{position:absolute;clip-path:inset(50%);margin:-1px;border:0;padding:0;width:1px;height:1px;overflow:hidden;word-wrap:normal!important;clip:rect(1px,1px,1px,1px)}.screen-reader-text:focus{display:block;top:5px;left:5px;z-index:100000;clip-path:none;background-color:#eee;padding:15px 23px 14px;width:auto;height:auto;text-decoration:none;line-height:normal;color:#444;font-size:1em;clip:auto!important}.disable-scrollbars::-webkit-scrollbar{background:0 0;width:0}.disable-scrollbars{scrollbar-width:none;-ms-overflow-style:none}.pull-right{float:right}.post-subheader{font-style:italic;color:var(--nc-tx-3)}.post-date{font-family:var(--nc-font-mono)}ul.post-list{list-style-type:none;padding-left:0}@media screen and (max-width:600px){.post-date{display:none}ul.post-list{list-style-type:disc;padding-left:0}}.post-date.no-date{display:none}ul.post-list.no-date{list-style-type:disc;padding-left:2rem}</style></head><body><header><h1>The stuff I do</h1><nav class="topnav" id="header-navbar" onclick="navbarToggle()"><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/")' data-goatcounter-click="navbar-Home" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">Home</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/posts/")' data-goatcounter-click="navbar-Posts" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">Posts</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/projects/")' data-goatcounter-click="navbar-Projects" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">Projects</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/apps/")' data-goatcounter-click="navbar-Apps" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">Apps</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/music/")' data-goatcounter-click="navbar-Music" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">Music</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/about/")' data-goatcounter-click="navbar-About" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">About</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/ring/")' data-goatcounter-click="navbar-Ring" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">Ring</a> <i class="nav-separator">♢</i> </span><span class="nav-item"><a class="nav-link" href="#" onclick='navbarNavigate("/feed.xml")' data-goatcounter-click="navbar-RSS" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">RSS</a> <i class="nav-separator">♢</i> </span><span style="cursor:pointer" class="nav-item" onclick="toggleDarkTheme()" data-goatcounter-click="toggle-theme" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">◐</span> <span class="icon hamburger"></span></nav></header><div class="content-container"><h2>Automatically merging Dependabot PRs on Github</h2><p class="post-subheader"><span id="post_date"></span> - 940 words - <span id="commentCounter"></span> <span id="comment_word"></span></p><p><a href="/posts" data-goatcounter-click="back-to-posts" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">← Posts</a></p><p>I have Dependabot set on many of my repos but I often get too lazy to check the PRs and merge them. On <a href="https://github.com/statox/api.statox.fr" target="_blank" rel="noopener noreferrer">my api</a> repo this is an issue because I really want to keep dependencies up to date. Here is what I did to have Dependabot's PRs merged automatically as they are created.</p><p>The file lives <a href="https://github.com/statox/api.statox.fr/blob/main/.github/workflows/dependabot-auto-merge.yml" target="_blank" rel="noopener noreferrer">there on Github</a></p><p><strong>At no point there is a need to generate a github access token by yourself. Dependabot will use its own</strong></p><h2 id="setup-tests" tabindex="-1">Setup tests <a class="header-anchor" href="#setup-tests">🔗</a></h2><p>For my api repo I use <code>mocha</code> to run the tests. I have 3 commands to be able to run the tests</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run <span class="token function">env</span>            <span class="token comment"># This triggers a podman-compose command starting the containers</span>
./src/tools/init-db.sh <span class="token comment"># Create the test database in the container</span>
<span class="token function">npm</span> run tests:all      <span class="token comment"># Call mocha and run the tests</span></code></pre><h2 id="setups-in-github" tabindex="-1">Setups in Github <a class="header-anchor" href="#setups-in-github">🔗</a></h2><h3 id="dependabot" tabindex="-1">Dependabot <a class="header-anchor" href="#dependabot">🔗</a></h3><p>Allow Dependabot to regularly create PRs with dependencies update.</p><p>In the Github repo settings: Security &gt; Code security and analysis &gt; Dependabot</p><p><img src="./dependabot_setup.png" alt="Dependabot setup screen"/></p><center><i>Enable the Dependabot alerts</i></center><p>For better configuration a file <code>github/dependabot.yml</code> can be created in the repo, see <a href="https://docs.github.com/en/code-security/dependabot/dependabot-version-updates/configuration-options-for-the-dependabot.yml-file" target="_blank" rel="noopener noreferrer">the doc</a> for more details.</p><h3 id="actions-settings" tabindex="-1">Actions settings <a class="header-anchor" href="#actions-settings">🔗</a></h3><p>Allow GitHub Actions to create and approve pull requests. This is needed because the workflow we will trigger will be responsible for approving the PR automatically.</p><p>In the Github repo settings: Code and automation &gt; Actions &gt; General &gt; Workflow permissions</p><p><img src="./allow_action_approve_PR.png" alt="Actions settings screen"/></p><center><i>Enable the actions to modify PRs</i></center><h3 id="branch-protection" tabindex="-1">Branch protection <a class="header-anchor" href="#branch-protection">🔗</a></h3><p>In the Github repo settings: Code and automation &gt; Branches &gt; Add rule</p><p>The rule needs to apply to the <code>main</code> branch (i.e. the one we'll be merging to).</p><p>We need two checks enforced by the rule:</p><ul><li><code>Require a pull request before merging</code> and <code>Require approvals</code>: The approval will be given by <code>github-action</code> bot throught the workflow</li><li><code>Require status checks to pass before merging</code>: The checks will be the success of the workflow itself and we'll make the workflow fail if the tests for the repo are not validated.</li></ul><p><img src="./branch_protection_setup.png" alt="Branch protection screen"/></p><center><i>Enforce PR approval and checks</i></center><h2 id="setup-the-workflow" tabindex="-1">Setup the workflow <a class="header-anchor" href="#setup-the-workflow">🔗</a></h2><p>In the repo create a file for the workflow like <code>.github/workflows/dependabot-auto-merge.yml</code></p><h3 id="trigger" tabindex="-1">Trigger <a class="header-anchor" href="#trigger">🔗</a></h3><p>We will trigger the workflow on PRs.</p><p><strong>TODO</strong> Find a way to trigger only for dependabot PRs, for now all MR will be automatically merged if they pass the tests.</p><ul><li><code>types</code>: Using <code>edited</code> is useful to debug the workflow while setting it up: once the MR is open, you can edit the workflow, push, comment <code>@dependabot rebase</code> on the PR and the workflow will be re-run</li></ul><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Test and AutoMerge PRs

<span class="token key atrule">on</span><span class="token punctuation">:</span>
    <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
        <span class="token key atrule">types</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>opened<span class="token punctuation">,</span> synchronize<span class="token punctuation">,</span> edited<span class="token punctuation">]</span>
        <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span></code></pre><h3 id="permissions" tabindex="-1">Permissions <a class="header-anchor" href="#permissions">🔗</a></h3><p>This changes the permissions of the github token that dependabot gets when creating the PR, we need two additional permissions.</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">permissions</span><span class="token punctuation">:</span>
    <span class="token comment"># This is needed to approve the PR</span>
    <span class="token key atrule">pull-requests</span><span class="token punctuation">:</span> write
    <span class="token comment"># This is needed to merge the PR https://github.com/cli/cli/issues/6695#issuecomment-1348430969</span>
    <span class="token key atrule">contents</span><span class="token punctuation">:</span> write</code></pre><p>Without these permissions the calls the the <code>gh</code> cli in the next steps fail with errors similar to this:</p><p><img src="./auto_merge_permissions_error.png" alt="gh cli permission error"/></p><center><i>Example of gh permission error</i></center><h3 id="filter-dependabot" tabindex="-1">Filter dependabot <a class="header-anchor" href="#filter-dependabot">🔗</a></h3><p>One way to have the whole workflow triggered only for dependabot's PR is to add a condition for the job:</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
    <span class="token key atrule">test-and-auto-merge</span><span class="token punctuation">:</span>
        <span class="token key atrule">if</span><span class="token punctuation">:</span> github.actor == 'dependabot<span class="token punctuation">[</span>bot<span class="token punctuation">]</span>'
        <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
        <span class="token key atrule">steps</span><span class="token punctuation">:</span>
            <span class="token comment"># [...]</span></code></pre><p>This could be improved to better factorize the code and have the tests running on all MR and the auto merge running only on dependabot PRs but since I'm the only one working on this repo and I don't use PRs for other reasons I will not bother with that.</p><h3 id="repo-setup-and-tests" tabindex="-1">Repo setup and tests <a class="header-anchor" href="#repo-setup-and-tests">🔗</a></h3><p>This is dependent on all repos though the important part is to run some tests. Here we need several setup steps:</p><ul><li>Install <code>python</code> throught a marketplace Github action to be able to install <code>podman-compose</code> with <code>pip</code></li><li>Install <code>podman</code> throught a marketplace Github action.</li><li>Install <code>node</code> to run build the project and run the tests.</li><li>Checkout the code, install the deps and run the tests.</li></ul><p>If these steps fail the following one will fail too, so the PRs tests will fail and the code will not be merged.</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
 <span class="token key atrule">test-and-auto-merge</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install python 3
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>python@v5
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">python-version</span><span class="token punctuation">:</span> <span class="token string">'3.x'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install podman
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> gacts/install<span class="token punctuation">-</span>podman@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install podman<span class="token punctuation">-</span>compose
        <span class="token key atrule">run</span><span class="token punctuation">:</span> pip3 install podman<span class="token punctuation">-</span>compose

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install node.js
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v4
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'latest'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout code
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">ref</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.head_ref <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Start podman environment
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run env

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Init db
        <span class="token key atrule">run</span><span class="token punctuation">:</span> ./src/tools/init<span class="token punctuation">-</span>db.sh

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run tests
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run tests<span class="token punctuation">:</span>all</code></pre><h3 id="handle-the-pr" tabindex="-1">Handle the PR <a class="header-anchor" href="#handle-the-pr">🔗</a></h3><p>Three important steps:</p><ul><li>Call the <code>fetch-metadata</code> action to get the <code>$PR_URL</code> variable referring to the current PR and used in the next steps.</li><li>Have the <code>github-action</code> bot approve the PR</li><li>Have the <code>github-action</code> bot set the <code>auto merge</code> setting for the PR, which will trigger the merge of the PR because all the checks will succeed.</li></ul><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
 <span class="token key atrule">test-and-auto-merge</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token comment"># [...]</span>
      <span class="token comment"># Setup and test steps</span>
      <span class="token comment"># [...]</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Dependabot metadata
        <span class="token key atrule">id</span><span class="token punctuation">:</span> metadata
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> dependabot/fetch<span class="token punctuation">-</span>metadata@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">github-token</span><span class="token punctuation">:</span> <span class="token string">"${{secrets.GITHUB_TOKEN}}"</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Approve the PR
        <span class="token key atrule">run</span><span class="token punctuation">:</span> gh pr review <span class="token punctuation">-</span><span class="token punctuation">-</span>approve "$PR_URL"
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">PR_URL</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>github.event.pull_request.html_url<span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">GH_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>secrets.GITHUB_TOKEN<span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Auto<span class="token punctuation">-</span>merge the PR
        <span class="token key atrule">run</span><span class="token punctuation">:</span> gh pr merge <span class="token punctuation">-</span><span class="token punctuation">-</span>rebase <span class="token punctuation">-</span><span class="token punctuation">-</span>auto "$PR_URL"
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">PR_URL</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>github.event.pull_request.html_url<span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">GH_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>secrets.GITHUB_TOKEN<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="result" tabindex="-1">Result <a class="header-anchor" href="#result">🔗</a></h2><p>Once all of that is configured the Dependabot PRs should be automatically handled.</p><p><img src="./PR_checks_tab.png" alt="PR checks tab"/></p><center><i>The check tab of the PR should have some results</i></center><p><img src="./PR_check_result.png" alt="PR checks results"/></p><center><i>The checks should point to a succesful action</i></center><p><img src="./PR_bots_results.png" alt="PR bots results"/></p><center><i>The various bots should have acted on the PR</i></center><h3 id="notification" tabindex="-1">Notification <a class="header-anchor" href="#notification">🔗</a></h3><p>When all of that is succesful I get emails from Github both for when the bot approves the PR and for when it merges it.</p><p><a href="/posts" data-goatcounter-click="back-to-posts" data-goatcounter-referrer="/posts/2024/04/github_dependabot_auto_merge/">← Posts</a></p><hr/><p></p><h3>Related posts</h3><p>No other posts in the category <span class="formatted-tag">[github]</span></p><hr/><comments><h3>Comments</h3><a class="add-comment-btn" href="https://github.com/statox/blog-comments/issues/35#new_comment_field" target="_blank" rel="noopener noreferrer"><button>Comment on Github</button></a><br/></comments><script>const reactionEmojis={laugh:"&#x1F600","+1":"&#x1F44D","-1":"&#x1F44E",hooray:"&#x1F389",confused:"&#x1F615",heart:"&#x2665",rocket:"&#x1F680",eyes:"&#x1F440"};function domReady(e){document.addEventListener("DOMContentLoaded",e),"interactive"!==document.readyState&&"complete"!==document.readyState||e()}function countReactions(e){const t={};return e.forEach(e=>{t[e.content]?t[e.content]++:t[e.content]=1}),t}function formatReactions(e){if(!e.length)return"";const n=countReactions(e);return Object.keys(n).reduce((e,t)=>{return e+'<span class="comment-reaction-item">'+(reactionEmojis[t]||`:${t}:`)+"&nbsp"+n[t]+"</span>"},"")}function appendComments(e){const o=document.querySelector("comments");var t=document.getElementById("commentCounter");t&&(t.innerText=e.length||0),e&&e.forEach&&0!==e.length?e.forEach(function(e){var t=formatCommentDate(new Date(e.created_at)),t=`<a href="${e.user.html_url} rel="noopener noreferrer" target="_blank">${e.user.login}</a>`+" on "+`<a href="${e.html_url}" rel="noopener noreferrer" target="_blank">${t}</a>`;let n="";n=(n=(n+='<div class="comment">')+'    <div class="comment-header">'+t+'</div>    <div class="comment-content">')+'        <div class="comment-text">'+e.body_html+"</div>",0<e.reactions.length&&(n+='        <div class="comment-reactions">'+formatReactions(e.reactions)+"</div>"),n+="    </div></div>",o.insertAdjacentHTML("beforeend",n)}):o.insertAdjacentHTML("beforeend","<p>No comments yet.</p>")}async function getComments(e){return(await fetch(`https://api.github.com/repos/statox/blog-comments/issues/${e}/comments`,{method:"GET",mode:"cors",cache:"no-cache",headers:{Accept:"application/vnd.github.v3.html+json"}})).json()}async function getReactions(e){return(await fetch(`https://api.github.com/repos/statox/blog-comments/issues/comments/${e}/reactions`,{method:"GET",mode:"cors",cache:"no-cache",headers:{Accept:"application/vnd.github.squirrel-girl-preview+json"}})).json()}function formatCommentDate(e){return e.getDate()+`/${e.getUTCMonth()+1}/`+e.getFullYear()}function setupCommentsInPage(t){domReady(async()=>{var e=await getComments(t);await Promise.all(e.map(async e=>{e.reactions=await getReactions(e.id)})),appendComments(e)})}function adaptToScreenSize(e){var t=new Date("Sat Apr 20 2024 00:00:00 GMT+0000 (Coordinated Universal Time)");let n=t.toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"}),o="comments";e.matches&&(n=t.toLocaleDateString(void 0,{year:"numeric",month:"numeric",day:"numeric"}),o="💬"),document.getElementById("post_date").textContent=n,document.getElementById("comment_word").textContent=o}setupCommentsInPage({commentIssueId:commentIssueId});var x=window.matchMedia("(max-width: 500px)");adaptToScreenSize(x),x.addListener(adaptToScreenSize)</script><a class="top-link hide" href="" id="js-top"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg> <span class="screen-reader-text">Back to top</span></a><script>const scrollToTopButton=document.getElementById("js-top");let scrollTimer;const scrollFunc=()=>{var o=window.scrollY;scrollToTopButton.className=0<o?"top-link show":"top-link hide",scrollTimer&&clearTimeout(scrollTimer),scrollTimer=setTimeout(()=>{scrollToTopButton.className="top-link hide"},3e3)},scrollToTop=(window.addEventListener("scroll",scrollFunc),()=>{var o=document.documentElement.scrollTop||document.body.scrollTop;0<o&&(window.requestAnimationFrame(scrollToTop),window.scrollTo(0,o-o/2))});scrollToTopButton.onclick=function(o){o.preventDefault(),scrollToTop()}</script></div><script data-goatcounter="https://statoxblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css"/><script src="https://kit.fontawesome.com/cc32401bee.js" crossorigin="anonymous"></script></body></html>