<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Circle packing algorithm (with kittens üê±)</title>
    <meta name="description" content="A personal blog where I write about my side projects">
    <meta name="keywords" content="statox blog">
    <meta property="og:title" content="The stuff I do">
    <meta property="og:url" content="https://www.statox.fr">
    <meta property="og:description" content="A personal blog where I write about my side projects">
    <meta property="og:type" content="website">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css">

    
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.20.0/themes/prism-tomorrow.css">

    
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/material.css">
    <link rel="stylesheet" href="/css/minesweeper.css">
    <link rel="stylesheet" href="/css/boids.css">

</head>
<body>
    <header>
        <h1>The stuff I do</h1>
        <nav>
            <a href="/">Home</a> /
            <a href="/notes/">Notes</a> /
            <a href="/about/">About</a> /
            <a href="/social/">Social</a> /
            <a href="/feed.xml">RSS</a>
        </nav>
    </header>

    <div class="content-container">
        
<h2>Circle packing algorithm (with kittens üê±)</h2>
<p><a href="/">‚Üê Posts</a></p>

<p>Inspired by a video by <a href="https://www.youtube.com/channel/UCvjgXvBlbQiydffZU7m1_aw" target="_blank" rel="noopener noreferrer">Daniel Shiffman on YouTube</a> I decided to create a short little project involving circle packing and kittens.</p>
<p>Before reading my rambling go and watch the kitties <a href="https://statox.github.io/p5-circles/" target="_blank" rel="noopener noreferrer">in the demo</a>.</p>
<p><em>Note that for a reason that I don't understand for now, the demo seems to be working only with chromium/chrome... Maybe I'll investigate that later on</em></p>
<p>And if that was cute enough to make you want to see the code, <a href="https://github.com/statox/p5-circles" target="_blank" rel="noopener noreferrer">here you are</a>.</p>
<h3>What does it mean?</h3>
<p>To quote <a href="https://en.wikipedia.org/wiki/Circle_packing" target="_blank" rel="noopener noreferrer">wiki</a></p>
<blockquote>
<p>In geometry, circle packing is the study of the arrangement of circles (of equal or varying sizes) on a given surface such that no overlapping occurs and so that no circle can be enlarged without creating an overlap.</p>
</blockquote>
<p>And to quote <a href="https://en.wikipedia.org/wiki/Kitten" target="_blank" rel="noopener noreferrer">the same source</a></p>
<blockquote>
<p>A kitten is a juvenile cat. After being born, kittens display primary <a href="https://en.wikipedia.org/wiki/Altriciality" target="_blank" rel="noopener noreferrer">altriciality</a> and are totally dependent on their mother for survival.</p>
</blockquote>
<p>So for this project I wanted to use some really cute pictures and duplicate them with a bunch of non overlapping circles.</p>
<h3>Loading the pictures</h3>
<p>Before packing circles on these cuties we first need to load the images in our p5.js sketch. To do so I created a <code>reset()</code> function which will be used each time I need a new image. It's goal is to get the color of each pixels on the image so that we can use the color later on:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">IMAGES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token string">'data/kitten1.png'</span><span class="token punctuation">,</span><br>    <span class="token string">'data/kitten2.jpg'</span><span class="token punctuation">,</span><br>    <span class="token string">'data/kitten3.jpg'</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Stop calling draw() while we load the picture otherwise we break everything</span><br>    <span class="token function">noLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// iterate through my image list</span><br>    imgIndex<span class="token operator">++</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>imgIndex <span class="token operator">>=</span> <span class="token constant">IMAGES</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        imgIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token constant">IMAGES</span><span class="token punctuation">[</span>imgIndex<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// load the image and get the color for each of its pixels</span><br>    img <span class="token operator">=</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token function">pixelDensity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        circles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        imgColors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>        img<span class="token punctuation">.</span><span class="token function">loadPixels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> d <span class="token operator">=</span> img<span class="token punctuation">.</span>pixels<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> d<span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            r <span class="token operator">=</span> img<span class="token punctuation">.</span>pixels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>            g <span class="token operator">=</span> img<span class="token punctuation">.</span>pixels<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>            b <span class="token operator">=</span> img<span class="token punctuation">.</span>pixels<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>            a <span class="token operator">=</span> img<span class="token punctuation">.</span>pixels<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>            imgColors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">color</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Start the packing again!</span><br>        <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Because p5.js is constantly calling the <code>draw()</code> function I need to use a little trick calling <code>noLoop()</code> to avoid calling <code>draw()</code> while there is no data, otherwise things will not work.</p>
<p>The interesting part of this function is how p5 gives access to the pixels of an image: After calling <code>img.loadPixels()</code>, the <code>img</code> object will have a <code>pixels</code> property containing a list of integers. For each pixels in the image, four integers are added to <code>pixels</code> one for each of the RGB values of the pixel and a last one for its alpha value.</p>
<p>Once we looped through all these values we have an array <code>imgColors</code> containing for <code>P5.Color</code> object üéâ</p>
<h3>Generating circles</h3>
<p>Before we pack the image with circles we need to generate one of them. Here our goal is the following: Return a new circle which does not overlap the others or return nothing (we will handle the failed generations later). So far the algorithm is not very complex: We have a list of existing circles <code>circles</code> (Empty at the beginning), we generate a random position <code>(x, y)</code> and a radius <code>r</code>, we then iterate on the list of existing circles and test if its distance to the newly generated one is larger than the sum of their radius (i.e. they don't overlap).</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">newCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token constant">MAX_INITIAL_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">const</span> intersection <span class="token operator">=</span> circles<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">other</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dist</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> other<span class="token punctuation">.</span>x<span class="token punctuation">,</span> other<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">&lt;</span> other<span class="token punctuation">.</span>r <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>intersection <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">let</span> color <span class="token operator">=</span> imgColors<span class="token punctuation">[</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> img<span class="token punctuation">.</span>width<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Now that we can generate one circle let's make a function which tries to generate a given amount of circles so that one iteration will see several ones created:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">newCircles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> totalNewCircles <span class="token operator">=</span> <span class="token constant">NEW_CIRCLES_BY_ITERATION</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> remainingAttemps <span class="token operator">=</span> <span class="token constant">NEW_CIRCLES_ATTEMPTS</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> countNewCircles <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span>countNewCircles <span class="token operator">&lt;</span> totalNewCircles <span class="token operator">&amp;&amp;</span> remainingAttemps <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        remainingAttemps<span class="token operator">--</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">const</span> newC <span class="token operator">=</span> <span class="token function">newCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newC <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            circles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newC<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            countNewCircles<span class="token operator">++</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Of course the more circles we generate the harder it become to find the right spot for a new one, that why we need to use a maximum number of attempts to avoid blocking the main loop.</p>
<h3>And making them grow</h3>
<p>Now that we can generate a bunch of new circle on each iteration, let's make them grow too and that's how we pack circles on kittens üí™</p>


<p><a href="/">‚Üê Posts</a></p>

<hr>
<comments>
    <h3>Comments</h3>
    <a class="add-comment" href="https://github.com/statox/blog-comments/issues/8#new_comment_field"  target="_blank" rel="noopener noreferrer">
        <button>Comment on Github</button>
    </a>
    <br>
</comments>

<script type="text/javascript">


function domReady(fn) {
    document.addEventListener('DOMContentLoaded', fn);
    if (document.readyState === 'interactive' || document.readyState === 'complete') {
        fn();
    }
}

async function getComments(url = '') {
    const response = await fetch(url, {
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache',
        headers: { Accept: 'application/vnd.github.v3.html+json' },
    });
    return response.json();
}

domReady(() => {
    const apiUrl = 'https://api.github.com/repos/statox/blog-comments/issues/8/comments';
    const appendComments = function (comments) {
        const commentSection = document.querySelector('comments');
        if (!comments || !comments.forEach || comments.length === 0) {
            commentSection.insertAdjacentHTML('beforeend', '<p>No comments yet.</p>');
            return;
        }
        comments.forEach(function (comment) {
            commentSection.insertAdjacentHTML(
                'beforeend',
                '<div class="comment">' +
                '‚Ä¢ <a href="' + comment.user.html_url + '" target="_blank">' + comment.user.login + '</a>' +
                ' on' +
                ' <a href="' + comment.html_url + '" target="_blank">' + new Date(comment.created_at).toUTCString() + '</a>' +
                comment.body_html +
                '</div>',
            );
        });
    };
    getComments(apiUrl).then(appendComments);
});
</script>

    </div>

    <script data-goatcounter="https://statoxblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <script async defer src="https://api.newcss.net/latest.js"></script>
    <noscript><img src="https://api.newcss.net/noscript.gif" alt=""></noscript>
</body>
</html>
