<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>The stuff I do</title>
    <meta name="description" content="A personal blog where I write about my side projects">
    <meta name="keywords" content="statox blog">
    <meta property="og:title" content="The stuff I do">
    <meta property="og:url" content="https://www.statox.fr">
    <meta property="og:description" content="A personal blog where I write about my side projects">
    <meta property="og:type" content="website">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css">

    
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css">

    
    <link rel="stylesheet" href="/css/index.css">

</head>
<body>
    <header>
        <h1>The stuff I do</h1>
        <nav>
            <a href="/">Home</a> /
            <a href="/about/">About</a> /
            <a href="/social/">Social</a> /
        </nav>
    </header>

    <div class="content-container">
        
<h2>Highlighting yanked text with pure vimscript</h2>

<p>A few days ago I saw <a href="https://blog.kdheepak.com/three-built-in-neovim-features.html#highlight-yanked-text" target="_blank" rel="noopener noreferrer">a blog post</a> showing a built-in way to highlight yanked text on neovim. The author uses neovim's lua integration combined with the <a href="https://neovim.io/doc/user/autocmd.html#TextYankPost" target="_blank" rel="noopener noreferrer"><code>:h TextYankPost</code></a> autocommand event:</p>
<pre class="language-vim"><code class="language-vim">augroup highlightYankedText<br>    <span class="token builtin">autocmd</span><span class="token operator">!</span><br>    <span class="token builtin">autocmd</span> TextYankPost <span class="token operator">*</span>  <span class="token keyword">silent</span><span class="token operator">!</span> lua require<span class="token string">'vim.highlight'</span><span class="token operator">.</span><span class="token function">on_yank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>augroup END</code></pre>
<p>I liked the idea of having visual feedback on my yanks but I am still reluctant to use the lua integration. Despite all the bad things you can read about vimscript online I like to keep my configuration in pure vimscript as much as possible mostly for portability reasons.</p>
<p>So I decided to <s>reinvent the wheel</s> replicate this behavior with pure vimscript! This was interesting to do because it involves playing with patterns and matches which are the basic building bricks of Vim's highlighting function. And because these are not tools that I need to use regularly so I am not very familiar with them.</p>
<p>So here is the result I am looking for: In this screen cap you can see me first yanking the word &quot;filetype&quot; with <code>yiw</code>, then the full line with <code>yy</code> and finally several lines:</p>
<p><img src="./flash_yanked_text.gif" alt="Demo of highlighted text"></p>
<p>In this article I want to detail the steps I followed to get this feature working and I hope this kind of iteration process can help new vimmers to get into vimscript.</p>
<h4>A reminder on how to highlight stuff</h4>
<p>First a bit of Vim terminology about highlighting:</p>
<ul>
<li>
<p>A <code>pattern</code> is basically a regular expression which can be used to search for some text.</p>
<p>Patterns can be as simple as plain text (e.g. <code>/TODO</code> ) or complex regexes with a lot of items as described in <a href="http://vimhelp.appspot.com/pattern.txt.html#pattern" target="_blank" rel="noopener noreferrer"><code>:h pattern</code></a>.</p>
</li>
<li>
<p>A <code>highlighting group</code> is a named group of highlighting instructions.</p>
<p>The <a href="http://vimhelp.appspot.com/syntax.txt.html#%3Ahighlight" target="_blank" rel="noopener noreferrer"><code>:highlight</code></a> command allows to list the existing groups when given no arguments. It also allows to create new groups or get details about the existing ones.  By default both Vim and Neovim have an <code>IncSearch</code> highlighting group which we will reuse to highlight our text. You can see what it looks like on your system with the command <code>:highlight IncSearch</code></p>
</li>
<li>
<p>Finally a <code>match</code> is a way to tell Vim to highlight a specific pattern using a specific highlighting group.</p>
<p>A match can be created with <a href="http://vimhelp.appspot.com/eval.txt.html#matchadd%28%29" target="_blank" rel="noopener noreferrer"><code>matchadd()</code></a>. The first argument is the name of an highlighting group as shown in the result of <code>:highlight</code> and the second argument is a pattern:</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">'TODO'</span><span class="token punctuation">)</span></code></pre>
<p>To delete a match simply use the ID returned by the previous command. Note that this command only works in the window where the match was created, this will be important later on.</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">call</span> <span class="token function">matchdelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></code></pre>
</li>
</ul>
<h4>Making the pattern work</h4>
<p>The first step to highlight yanked text is to be able to match the last yanked text. Fortunately, <a href="http://vimhelp.appspot.com/motion.txt.html#%27%5b" target="_blank" rel="noopener noreferrer"><code>:h '[</code></a> tells us that Vim has two marks <code>'[</code> and <code>']</code> which are positioned on the first and last characters of the previously changed or yanked text.</p>
<p>And <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c%25%27m" target="_blank" rel="noopener noreferrer"><code>:h /\%'m</code></a> tells us that we can use such marks in a pattern, so my first attempt looked like this:</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">"\\%'\\[.*\\%']"</span><span class="token punctuation">)</span></code></pre>
<p>The main items of the pattern are the following:</p>
<ul>
<li><code>'[</code> is the mark I mentioned before but <code>[</code> being a special character (used in <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5b%5d" target="_blank" rel="noopener noreferrer"><code>:h /[]</code></a>) it needs to be escaped hence <code>'\\[</code>. Note that each <code>\</code> needs to be escaped to be used in the command.</li>
<li>Given this previous point, <code>\\%'\\[</code> is the way to use <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c%25%27m" target="_blank" rel="noopener noreferrer"><code>:h /\%'m</code></a> with the <code>'[</code> mark, matching the beginning of the previously yanked text.</li>
<li><code>.*</code> allows to match any characters any number of time.</li>
<li><code>\\%']</code> is the equivalent of the first item with the <code>']</code> mark. Note that here <code>]</code> doesn't need to be escaped since there is no risk of confusion with <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5b%5d" target="_blank" rel="noopener noreferrer"><code>:h /[]</code></a>.</li>
</ul>
<p>This is a great first attempt which kind of works on some simple cases but fails when yanking text on several lines. This is because the <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f." target="_blank" rel="noopener noreferrer"><code>.</code></a> atom doesn't match end of lines characters, so we need to use <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c_." target="_blank" rel="noopener noreferrer"><code>\_.</code></a> instead:</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">"\\%'\\[\\_.*\\%']"</span><span class="token punctuation">)</span></code></pre>
<p>That is better but still not completely working, for example the first and last characters of the yanked text are not highlighted. That's the moment where we turn to the doc and read a bit more what <a href="http://vimhelp.appspot.com/pattern.txt.html#%2f%5c%25%27m" target="_blank" rel="noopener noreferrer"><code>:h /\%'m</code></a> has to say, particularly this:</p>
<pre><code>Example, to highlight the text from mark 's to 'e:
	/.\%&gt;'s.*\%&lt;'e..
Note that two dots are required to include mark 'e in the match.  That
is because &quot;\%&lt;'e&quot; matches at the character before the 'e mark, and
since it's a |/zero-width| match it doesn't include that character.
</code></pre>
<p>Easy peasy, let's reuse the same thing but with our marks <code>'[</code> and <code>']</code>:</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span></code></pre>
<p><em>Important note</em>: Some of this escaping could be greatly simplified using a different magic mode but it's not my point here. For more information on magic in Vim see <a href="http://vimhelp.appspot.com/pattern.txt.html#%2fmagic" target="_blank" rel="noopener noreferrer"><code>:h /magic</code></a></p>
<p>So after a few tests yanking some random text, using <code>matchadd</code> to highlight it and <code>matchdelete</code> to remove the highlighting I am satisfied with the result, it is then time to automatically highlight our text.</p>
<h4>Using the pattern automatically</h4>
<p>Vim provides since it <a href="https://github.com/vim/vim/commit/7e1652c63c96585b9e2235c195a3c322b1f11595" target="_blank" rel="noopener noreferrer">patch 8.0.1394</a> the <a href="http://vimhelp.appspot.com/autocmd.txt.html#TextYankPost" target="_blank" rel="noopener noreferrer"><code>:h TextYankPost</code></a> autocommand event which triggers just after a yank or deleting command. So our first step is to create a function triggered by this event:</p>
<pre class="language-vim"><code class="language-vim">augroup highlightYankedText<br>    <span class="token builtin">autocmd</span><span class="token operator">!</span><br>    <span class="token builtin">autocmd</span> TextYankPost <span class="token operator">*</span> <span class="token keyword">call</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>augroup END<br><br><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span><br><span class="token keyword">endfunction</span></code></pre>
<p>As you can see I put my autocommand in an <a href="http://vimhelp.appspot.com/autocmd.txt.html#%3Aaugroup" target="_blank" rel="noopener noreferrer"><code>augroup</code></a> because <strong><em>every time you use an autocommand without an augroup you make a kitten cry</em></strong> 😿... and <a href="https://vi.stackexchange.com/q/9455/1841" target="_blank" rel="noopener noreferrer">for other reasons too</a>.</p>
<p>That is great! Each time we yank some text it gets highlighted... but then it remains highlighted indefinitely. So let's simply use a timer to delete the match we just created. Note that the function puts the id of the newly created match in a global variable which is kind of ugly but pretty pratical to access it in the <code>DeleteTemporaryMatch()</code> function.</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> g<span class="token punctuation">:</span>idTemporaryHighlight <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token function">timer_start</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'DeleteTemporaryMatch'</span><span class="token punctuation">)</span><br><span class="token keyword">endfunction</span><br><br><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">DeleteTemporaryMatch</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token function">matchdelete</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>idTemporaryHighlight<span class="token punctuation">)</span><br><span class="token keyword">endfunction</span></code></pre>
<h4>Making the feature reliable</h4>
<p>The previous code kind of works but some edge cases are problematic:</p>
<ul>
<li>When I yank two different texts too quickly sometimes the <code>DeleteTemporaryMatch()</code> function doesn't have the time to delete the previous match.</li>
<li>More importantly, when I switch to another window just after yanking some text, <code>deletematches()</code> fails because the matches id are local to a window.</li>
</ul>
<p>So let's put the ids in a list, with the window id where they were created:</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">FlashYankedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">'g:yankedTextMatches'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token keyword">let</span> g<span class="token punctuation">:</span>yankedTextMatches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br>    <span class="token keyword">endif</span><br><br>    <span class="token keyword">let</span> matchId <span class="token operator">=</span> <span class="token function">matchadd</span><span class="token punctuation">(</span><span class="token string">'IncSearch'</span><span class="token punctuation">,</span> <span class="token string">".\\%>'\\[\\_.*\\%&lt;'].."</span><span class="token punctuation">)</span><br>    <span class="token keyword">let</span> windowId <span class="token operator">=</span> <span class="token function">winnr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">call</span> <span class="token function">add</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>yankedTextMatches<span class="token punctuation">,</span> <span class="token punctuation">[</span>windowId<span class="token punctuation">,</span> matchId<span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token keyword">call</span> <span class="token function">timer_start</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'DeleteTemporaryMatch'</span><span class="token punctuation">)</span><br><span class="token keyword">endfunction</span></code></pre>
<p>Now <code>DeleteTemporaryMatch()</code> can simply dequeue the <code>g:yankedTextMatches</code> list and remove the matches on the corresponding window:</p>
<pre class="language-vim"><code class="language-vim"><span class="token keyword">function</span><span class="token operator">!</span> <span class="token function">DeleteTemporaryMatch</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><br>    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>yankedTextMatches<span class="token punctuation">)</span><br>        <span class="token keyword">let</span> <span class="token keyword">match</span> <span class="token operator">=</span> <span class="token function">remove</span><span class="token punctuation">(</span>g<span class="token punctuation">:</span>yankedTextMatches<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><br>        <span class="token keyword">let</span> windowID <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>        <span class="token keyword">let</span> matchID <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br><br>        <span class="token keyword">try</span><br>            <span class="token keyword">call</span> <span class="token function">matchdelete</span><span class="token punctuation">(</span>matchID<span class="token punctuation">,</span> windowID<span class="token punctuation">)</span><br>        <span class="token keyword">endtry</span><br>    <span class="token keyword">endwhile</span><br><span class="token keyword">endfunction</span></code></pre>
<p>For good measures the call to <code>matchdelete()</code> is enclosed in a <code>try...catch</code> block, just in case something else fails and I don't want to be bothered with an error message.</p>
<p>And here we are! With about 20 lines of vimscript we reimplemented the highlight yanked text feature!</p>
<h4>Turning it into a plugin</h4>
<p>Now that we have a code working properly, we could leave that in our <code>.vimrc</code> and live happily with that... But it would be even better to make it a plugin! This way the functions will be loaded only when necessary (and thus, avoid increasing your startup time), we can get rid of global variables and just have a clean line in our <code>.vimrc</code>, and while we are at it we could create a variable to control how long the flash should last... And that's actually what I did!</p>
<p>I think the specific of how I turned my code into a plugin would make this post way too long, so the resulting plugin can be found <a href="https://github.com/statox/vim-flash-yanked-text" target="_blank" rel="noopener noreferrer">on my github</a> and I am of course available to answer any questions you could have about it.</p>


<p><a href="/">← Posts</a></p>

    </div>

    <script data-goatcounter="https://statoxblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <script async defer src="https://api.newcss.net/latest.js"></script>
    <noscript><img src="https://api.newcss.net/noscript.gif" alt=""></noscript>
</body>
</html>
